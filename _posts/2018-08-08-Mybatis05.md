---
title: Mybatis映射文件（二）
date: 2018-08-08 20:01:09
categories:
    - Mybatis
tags:
    - Mybatis
    - Basic
    - Java
---

本文将在[Mybatis映射文件（一）](https://wocaishiliuke.github.io/mybatis/2018/08/07/Mybatis04/)的基础上进一步探讨，包括动态SQL和resultMap等

<!-- more -->

##### 目录
+ I.动态SQL
+ II.resultMap
+ III.参考

---

# I.动态SQL

> 动态SQL是mybatis的强大特性之一，解决了其他框架拼接SQL的复杂度。MyBatis3又精简了元素种类，采用基于OGNL的表达式淘汰了大部分元素，完成动态生成SQL的功能。

#### 1.if

> - if的test属性支持OGNL表达式和简单的Java代码
> - 判断中的参数取值同样与_parameter有关，参考[Mybatis映射文件（1）](https://wocaishiliuke.github.io/mybatis/2018/08/07/Mybatis04/)中的传参接参部分

```
//单个参数+不使用@Param，要用_parameter判断
public List<User> queryUserIf(String password);

<select id="queryUserIf" resultType="User">
    select * from tb_user where 1 = 1
    <if test="_parameter != null and _parameter != ''">
        AND password = #{password}
    </if>
</select>
```

```
//多个参数或使用@Param，要到_parameter这个ParamMap中取参进行判断
public List<User> queryUserAnnoIf(@Param("password") String password);

<select id="queryUserAnnoIf" resultType="User">
    select * from tb_user where 1 = 1
    <!-- <if test="param1 != null and param1.trim() != ''"> -->
    <!-- <if test="password != null and password.trim() != ''"> -->
    <!-- 简单的Java代码也可以 -->
    <if test="password != null &amp;&amp; !''.equals(password.trim())">
        AND password = #{password}
    </if>
</select>
```

> - &在XML中是非法字符，要用\&\a\m\p\;代替
> - 这里使用1=1规避了where的尴尬，实际中不推荐，稍后使用where标签解决
> - 动态SQL判断中的取参，如上例所示，具体参考Mybatis映射文件（1）即可，后面不再详述。

#### 2.choose、when、otherwise

> - 与if一样做判断使用，但区别在于只能从中择其一项，类似Java中的switch语句
> - 适用多选一的情况。注意书写顺序（条件优先级），因为只会匹配一个条件

```
public List<User> queryUserChoose(@Param("sex") Integer sex, @Param("password") String password);

<select id="queryUserChoose" resultType="User">
    select * from tb_user where 1 = 1
    <choose>
        <when test="sex != null">AND sex = #{sex}</when>
        <when test="password != null and password.trim() != ''">AND password = #{password}</when>
        <otherwise>AND age = 22</otherwise>
    </choose>
</select>
```

#### 3.where、set、trim

###### 3.1 where

> 智能的添加WHERE关键字。有一定的纠错功能，会去除开始多余的AND或OR

```
<!-- 如果不满足条件，就会多个where，报错 -->
<select id="queryUserWithoutWhere" resultType="User">
    select * from tb_user where
    <if test="password != null and password.trim() != ''">
        password = #{password}
    </if>
</select>
```

```
public List<User> queryUserWhere(@Param("password") String password);

<select id="queryUserWhere" resultType="User">
    select * from tb_user
    <where>
        <if test="password != null and password.trim() != ''">
            AND password = #{password}
        </if>
    </where>
</select>
```

###### 3.2 set

> 同WHERE相似，智能的添加SET关键字，会去除最后多余的","。多用于UPDATE语句

```
public int updateUserSet(User user);

<update id="updateUserSet" parameterType="User">
    UPDATE tb_user
    <set>
        <if test="sex != null">
            sex = #{sex},
        </if>
        <if test="password != null and password.trim() != ''">
            password = #{password},
        </if>
    </set>
    WHERE id = #{id}
</update>
```

> 如果没有一个条件满足，UPDATE tb_user WHERE id = #{id}也会报语法错误

###### 3.3 trim

> 可替代where和set标签，常用属性包括prefix、prefixOverrides、suffixOverrides。等价的where和set标签如下

```
<trim prefix="WHERE" prefixOverrides="AND |OR ">
  ... 
</trim>
```

```
<trim prefix="SET" suffixOverrides=",">
  ...
</trim>
```

> 注意，这里的管道操作符不能写成"AND \| OR",这样对OR无效。另外不区分大小写and/AND都可以

```
public List<User> queryUserTrimWhere(@Param("password") String password);

<select id="queryUserTrimWhere" resultType="User">
    select * from tb_user
    <!-- 注意这里的管道操作符不能写成AND | OR,这样对OR无效 -->
    <trim prefix="WHERE" prefixOverrides="and |OR">
        <if test="password != null and password.trim() != ''">
            AND password = #{password}
        </if>
    </trim>
</select>
```

```
public int updateUserTrimSet(User user);

<update id="updateUserTrimSet" parameterType="User">
    UPDATE tb_user
    <trim prefix="SET" suffixOverrides=",">
        <if test="sex != null">
            sex = #{sex},
        </if>
        <if test="password != null and password.trim() != ''">
            password = #{password},
        </if>
    </trim>
    WHERE id = #{id}
</update>
```

#### 4.foreach

> - 用来遍历任何可迭代对象，如List、Set、Map或者数组等。
> - index是当前迭代的次数，item 是本次迭代获取的元素。当使用Map对象（或者Map.Entry对象的集合）时，index是键，item 是值
> - 常用于IN条件语句

```
public List<User> queryUserForeachList(@Param("ids") List<Long> ids);

<select id="queryUserForeachList" parameterType="list" resultType="User">
    select * from tb_user
    <where>
        <if test="ids != null and ids.size() > 0">
            AND id IN
            <foreach collection="ids" item="id" index="index" open="(" separator="," close=")">#{id}</foreach>
        </if>
    </where>
</select>
```

```
public List<User> queryUserForeachSet(@Param("ids") Set<Long> ids);

<select id="queryUserForeachSet" parameterType="collection" resultType="User">
    select * from tb_user
    <where>
        <if test="ids != null and ids.size() > 0">
            AND id IN
            <foreach collection="ids" item="id" index="index" open="(" separator="," close=")">#{id}</foreach>
        </if>
    </where>
</select>
```

```
public List<User> queryUserForeachArray(@Param("ids") Long[] ids);

<select id="queryUserForeachArray" parameterType="Long[]" resultType="User">
    select * from tb_user
    <where>
        <if test="ids != null and ids.length > 0">
            AND id IN
            <foreach collection="ids" item="id" index="index" open="(" separator="," close=")">#{id}</foreach>
        </if>
    </where>
</select>
```

> 这里不讨论集合和数组的传参问题，具体可参考前面章节的讨论

#### 5.bind

> bind元素可以在OGNL表达式中创建一个变量并将其绑定到上下文

```
public List<User> queryUserBind(@Param("password") String password);

<select id="queryUserBind" parameterType="String" resultType="User">
    <bind name="id" value="3"/>
    select * from tb_user
    <where>
        <if test="password != null and password.trim() != ''">AND password = #{password}</if>
        <if test="id != null">AND id = #{id}</if>
    </where>
</select>
```

#### 6.多数据库支持

TODO

#### 7.可插拔脚本语言

TOD

---

# II.resultMap

---

# III.参考