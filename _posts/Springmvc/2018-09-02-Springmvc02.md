---
title: SpringMVC请求映射
date: 2018-09-02 00:00:00
categories:
    - SpringMVC
tags:
    - SpringMVC
    - Basic
    - Java
---

本文将介绍SpringMVC的请求映射、参数绑定、信息转换等的基本使用

<!-- more -->

##### 目录
+ I.请求映射
+ II.接口方法
+ III.接参


---

# I.请求映射

SpringMVC中的Controller，以及每个Controller中的方法，通过**@RequestMapping**和请求形成映射

## @RequestMapping注解

该注解用于指定哪个Controller或方法处理怎样的请求。可用于类或方法

> 虽然该注解在org.springframework.web.bind.annotation包下，但它不算是参数绑定注解

|属性|类型|是否必须|备注|
|:---|:---|:----|:---|
|value|String[]|N|映射的请求地址，**只有该属性时可省略**|
|name|String|N|指定映射地址别名|
|method|RequestMethod[]|N|限定请求方式类型，未指定时可处理任意请求方法|
|consumes|String[]|N|限定请求提交内容的类型（Content-Type）|
|produces|String[]|N|限定返回内容的类型（必须是请求头Accept中包含的类型）|
|params|String[]|N|限定请求中必须包含某些参数|
|headers|String[]|N|限定请求中必须包含指定header项|
|Path|String[]|N|在Servlet环境中只有:uri路径映射（如/haha.do），也支持ant路径（如/haha/*.do。方法层面支持相对路径（如haha.do）|

#### 1.常用属性

###### 1.1 value属性

限定请求路径（详见下述：路径匹配）

- 默认属性，即只有该属性时可省略

```
@RequestMapping("/hello")
@RequestMapping(value = "/hello")
```

- 可以是空串，则映射到http://localhost:8080/contextPath

```
@RequestMapping(value = "")
```

###### 1.2 method属性

限定请求方法，包括GET、POST、PUT、DELETE、HEAD、OPTIONS、PATCH、TRACE。方法不对会报405

```
@RequestMapping(value = "/hello", method = RequestMethod.GET)
@RequestMapping(value = "/hello", method = {RequestMethod.GET, RequestMethod.POST})
```

###### 1.3 consumes属性

限定请求提交的内容类型（Content-Type），如"application/json"、"text/html"等

```
//只处理Content-Type="text/html"的请求
@RequestMapping(value = "/hello", consumes = "text/html")
```

###### 1.4 produces属性

限定请求返回的内容类型，必须是请求头Accept中包含的类型

```
@RequestMapping(value = "/hello", method = RequestMethod.GET, produces = "application/json")
```

###### 1.5 params属性

限定请求中必须包含某些参数

```
/**
param1：必须有，可以有值或无值
param2：必须没有，无论是有值或无值的
param3：必须有，且值必须为a（=前后不能加空格，即param3 = a会报400）
param4：可以有或没有，存在时可以有值或无值，有值时不能为b（即param4=b）
*/
@RequestMapping(value = "/hello", params = {"param1", "!param2", "param3=a", "param4!=b"})
```

###### 1.6 headers属性

限定请求中必须包含指定的header项

```
//请求Referer必须来自baidu
@RequestMapping(value = "/hello", headers = "Referer=http://www.baidu.com")
```

#### 2.路径匹配

即讨论value中的请求路径

###### 2.1 标准URL

规则：类上路径 + 方法上路径

> 如果value中的路径没有以/开头，SpringMVC会自动加上

```
@Controller
@RequestMapping(value = "/hello")
public class HelloController {
    @RequestMapping(value = "/test", method = RequestMethod.GET)
    public ModelAndView hello() {
        ModelAndView mv = new ModelAndView("hello");
        mv.addObject("msg", "Hello world!");
        return mv;
    }
}
```

###### 2.2 Ant风格（通配符）

|符号|作用|
|:-|:--------|
|?|一个字符|
|*|0个或者多个字符|
|**|0个或者多个路径|

- **?**

> - http://localhost:9091/hello/a/test2 可以
> - http://localhost:9091/hello/ab/test2 不可以
> - http://localhost:9091/hello/a/b/test2 不可以
> - http://localhost:9091/hello//test2 不可以

```
@RequestMapping(value = "/?/test2")
public ModelAndView test2() {
    ...
}
```

- **\***

> - http://localhost:9091/hello/a/test3 可以
> - http://localhost:9091/hello/ab/test3 可以
> - http://localhost:9091/hello/a/b/test3 不可以
> - http://localhost:9091/hello//test3 不可以
> - http://localhost:9091/hello/*/test3 可以
> - http://localhost:9091/hello///test3 不可以

```
@RequestMapping(value = "/*/test3")
public ModelAndView test3() {
    ...
}
```

- **\*\***

> - http://localhost:9091/hello/a/test4 可以
> - http://localhost:9091/hello/ab/test4 可以
> - http://localhost:9091/hello/a/b/test4 不可以
> - http://localhost:9091/hello//test4 **可以**
> - http://localhost:9091/hello/*/test4 可以
> - http://localhost:9091/hello///test3 **可以**

```
@RequestMapping(value = "/**/test4")
public ModelAndView test4() {
    ...
}
```

###### 2.3 rest风格（占位符）

占位符{}路径，也是种传参方式。比?后拼接参数稍安全，与@PathVariable配和进行传接参

> - http://localhost:9091/hello/alvin/5/test5 可以
> - http://localhost:9091/hello/alvin/test5 不可以，报404
> - http://localhost:9091/hello/alvin/a/test5 不可以，报400

```
@RequestMapping(value = "/{name}/{id}/test5")
public ModelAndView test5(@PathVariable("name") String name, @PathVariable("id") Long id) {
    ...
}
```

# II.接口方法

#### 1.方法参数

Controller接口中的方法参数可以为：

```
HttpServletRequest或ServletRequest
HttpServletResponse或ServletResponse
HttpSession
InputStream
OutputStream
Reader
Writer
java.util.Locale
java.security.Principal
HttpEntity<?>
Map
Model
ModelMap
org.springframework.web.servlet.mvc.support.RedirectAttributes
org.springframework.validation.Errors
org.springframework.validation.BindingResult
org.springframework.web.bind.support.SessionStatus
org.springframework.web.util.UriComponentsBuilder
org.springframework.web.context.request.NativeWebRequest
org.springframework.web.context.request.WebRequest
@PathVariable、@MatrixVariable
@RequestParam、@RequestHeader、@RequestBody、@RequestPart
```

> - 其中Model和ModelMap是Spring提供的，而非Servlet API。其中包含了Map对象用来存储数据。当方法上使用Model参数，每次请求时，SpringMVC都会创建Model对象，传递给该方法。
> - 返回值是String时，即为视图名

#### 2.方法返回值

Controller接口中的方法返回值可以为：

```
org.springframework.ui.Model
org.springframework.web.servlet.ModelAndView
org.springframework.web.servlet.View
Map<k,v>
String
HttpEntity或ResponseEntity
java.util.concurrent.Callable
org.springframework.web.context.request.async.DeferredResult
void
```

> - 常用Model或ModelMap作为参数，使用ModelAndView作为方法返回值。则返回值中既包含数据模型也包含视图信息
> - 当方法void时，一般用于Response输出页面。此时需要将HttpServletResponse或OutputStream作为形参，或使用@ResponseStatus，否则SpringMVC会将@RequestMapping中的路径作为视图名，交由试图解析器处理，一般会报404视图找不到。[参考官方说明](https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-ann-return-types)

#### 3.Model、ModelMap、ModelAndView的使用

```
//ModelMap和Model，配合返回String使用
@RequestMapping("method1")
public String method1(ModelMap model /**Model model*/) {
    model.addAttribute("msg", "使用Model");
    return "hello";
}

@RequestMapping("method2")
public ModelAndView method2() {
    ModelAndView mv = new ModelAndView();
    mv.addObject("msg", "使用ModelAndView");
    mv.setViewName("hello");
    return mv;
}
```

#### 4.其他常用方法参数

```
//HttpServletRequest、HttpServletResponse、HttpSession
@RequestMapping("method3")
public String method3(HttpServletRequest request, HttpServletResponse response, HttpSession session, Model model) {
    StringBuffer sb = new StringBuffer();
    sb.append("request：" + request + "<br/>");
    sb.append("response：" + response + "<br/>");
    sb.append("session：" + session + "<br/>");
    sb.append("request.RemoteUser：" + request.getRemoteUser() + "<br/>");
    sb.append("sessionId：" + session.getId() + "<br/>");
    model.addAttribute("msg", sb.toString());
    return "hello";
}
```

# III.接参

使用GET或POST方式提交数据时，数据编码格式由请求头中的ContentType（MIME类型）指定，接参方式也随之变化：

|ContentType|接参方式|
|:----------|:------|
|application/x-www-form-urlencoded|@RequestParam、@ModelAttribute更方便；@RequestBody也能处理（当然是POST的，GET没有请求体。此时要用String接收，不能用POJO）|
|multipart/form-data|多用于文件上传，不能使用@RequestBody|
|application/json、application/xml等|必须使用@RequestBody|

> - GET请求没有请求体，参数使用request.getParameter获取。此时不论是application/x-www-form-urlencoded或application/json，都可以使用@RequestParam接收

> - MIME(Multipurpose Internet Mail Extension)类型是一种表示文档的性质和格式的标准方法。浏览器中使用MIME类型来告诉服务器如何处理文档数据，而不是通过文件扩展名

```
# 格式
type/subtype

# 示例
text/plain  // 一个纯文本
text/html   //html文件
image/jpeg     //一个jpeg格式的图片
application/octet-stream //进行下载操作
multipart/form-data     // 表单数据

# 请求中的contentType
contentType:[<mediatype>][,charset][,boundary]（boundary：区分每对key/value 的分割线，实质为随机的字符串）
```

> - application/x-www-form-urlencoded时原生form表单默认的enctype类型，数据以key=value的形式被编码。GET会追加到url?后，POST会放入请求体
> - multipart/form-data也是原生form表单中的enctype类型

## @RequestParam

|属性|类型|是否必须|说明|
|:--|:---|:-----|:---|
|value|String|否|参数名|
|name|String|否|value别名|
|required|boolean|否|是否必须，默认true|
|defaultValue|String|否|默认值，在没有传递该参数时使用。**使用defaultValue时required失效**|

```
@RequestMapping("/test1")
public String test(@RequestParam(value = "username", required = false) String username, @RequestParam("id") Long id, Model model) {
    User user = new User();
    user.setId(id);
    user.setUsername(username);
    model.addAttribute("msg", user.toString());
    return "hello";
}
```




## @PathVariable

获取请求URL中的动态参数。配合{}占位符请求使用

|属性|类型|是否必须|说明|
|:--|:---|:-----|:---|
|value|String|否|参数名，省略时默认绑定同名参数|

> 示例见上述

## @RequestHeader

获取请求头中的信息

|属性|类型|是否必须|说明|
|:--|:---|:-----|:---|
|value|String|否|参数名|
|name|String|否|value别名|
|required|boolean|否|是否必须，默认true|
|defaultValue|String|否|默认值，在没有传递该参数时使用|

> 因为返回void，如果不加HttpServletResponse做形参，springmvc会把testHeader(RequestMapping的value)作为视图名，继而报404。也可以使用OutputStream或@ResponseStatus

```
@RequestMapping("testHeader")
public void testHeader(@RequestHeader("User-Agent") String agent,
                       @RequestHeader("Accept") String[] accepts, HttpServletResponse response) {
    logger.info("User-Agent:" + agent);
    for (String accept : accepts) {
        logger.info(accept);
    }
}
```

## @CookieValue

获取Cookie中的数据

|属性|类型|是否必须|说明|
|:--|:---|:-----|:---|
|value|String|否|参数名|
|name|String|否|value别名|
|required|boolean|否|是否必须，默认true|
|defaultValue|String|否|默认值，在没有传递该参数时使用|

> 这里使用@ResponseStatus，原因同上

```
@RequestMapping(value = "/testCookie")
@ResponseStatus(HttpStatus.OK)
public void testCookie(@CookieValue(value = "JSESSIONID", defaultValue = "") String sessionId) {
    logger.info("JSESSIONID:" + sessionId);
}
```

## @SessionAttributes

**指定将哪些属性放入HttpSession。只能作用类，不能注解方法**

|属性|类型|是否必须|说明|
|:--|:---|:-----|:---|
|value|String|否|Model中的属性名，即存储在HttpSession中的属性名|
|name|String|否|value别名|
|types|Class<?>[]|否|是否必须，默认true|

## @ModelAttribute

将请求参数绑定到Model对象。可注释方法或参数