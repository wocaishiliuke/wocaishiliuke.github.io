---
title: Ali ECS操作记录
date: 2018-06-03 19:01:09
categories:
    - Linux
tags:
    - Linux
    - Ubuntu
    - Basic
---

本文用于记录Aliyun ECS Ubuntu 16.04的操作，持续更新。

<!-- more -->

##### 目录
+ I.ECS操作


---
# I.ECS操作

实例已经默认安装了SSH client和SSH server。

## 1.登陆

### 1.1 控制台登陆

配置实例网络和安全组等后，可先在阿里云控制台登录。使用*远程连接密码*登录页面终端，再使用用户密码登录实例。

```shell
# 查看是否有sshd进程
ps -e|grep ssh
# 或者查看22端口是否被sshd占用
sudo netstat -anp|grep :22
```

### 1.2 本地登陆

#### 1.2.1 本地为Linux环境
- 方式1：用户名密码登录
- 方式2：SSH密钥登录

##### 方式1

```shell
# 远程ssh用户密码登录
ssh root@公网IP
```

> 如果出现下述报错，很有可能是ECS的sshd禁止了远程密码登陆

```
Disconnected:No supported authentication methods available
```

> 可在控制台登陆或ssh密钥登陆后，修改ECS配置：

```shell
vim /etc/ssh/sshd_config
# 修改允许远程密码登陆
PasswordAuthentication yes

# 重启sshd服务
service ssh restart
```

##### 方式2

> 阿里云提供了[创建SSH密钥对](https://help.aliyun.com/document_detail/51793.html?spm=a2c4g.11186623.4.1.1c27bf87Sh7S5L)，而这里使用本地工具ssh-keygen生成。

- step1：生成公私密钥对

```shell
ssh-keygen -t rsa -C "top@123.com" -f ali01_rsa
```

> 配置本地多密钥对管理

```shell
~/.ssh$ cat config 
# gitlab
...

# github
...

# ali01
Host #ECS实例名
HostName #公网IP
port 22
User root
PreferredAuthentications publickey
IdentityFile ~/.ssh/ali01_rsa
```

- step2：导入公钥到ECS

推荐使用阿里云提供的[导入SSH 密钥对](https://help.aliyun.com/document_detail/51793.html#title-avz-neb-cy7)和[绑定SSH密钥对](https://help.aliyun.com/document_detail/51793.html#title-dyp-rol-4k7)，然后重启实例即可。

> 也可以密码登录到ECS后手动导入：

```shell
# 手动导入,将公钥复制进去
vim .ssh/authorized_keys

# 免密快捷登录
ssh ECS实例名
```

#### 1.2.2 本地为Windows环境

Windows可以借助PuTTY、Xshell、SecureCRT等进行连接。
- 方式1：[用户名密码登录](https://help.aliyun.com/document_detail/25434.html#h2-url-3)
- 方式2：SSH密钥登录

##### 方式1

使用PuTTY连接：
- Host：ECS的公网IP
- Port：22
- Connection type：SSH
- Close window on eixt：Only on clean exit

##### 方式2

和Linux客户端使用SSH密钥登录相同。这里也不使用官方提供的自动生成SSH密钥对功能（在服务器上），选择在本地git bash中手动生成，然后把公钥在控制台配置到ECS并绑定。

- 在控制台配置好公钥，并将密钥对绑定到该ECS（相当于手动加入authorized_keys）
- putty要求密钥是.ppk格式，所以先使用puttygen转化
- 再通过putty使用私钥的.ppk格式登陆

> 配置了密钥对登陆，再使用密码登陆会报：

```
No supported authentication methods available (server sent: publickey)
```

先看sshd配置是否开启了密码登陆。如果不行，再在控制台重置登陆密码后重启

```shell
PasswordAuthentication yes

# 重启sshd服务
service ssh restart
```